<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>로뎀 발표곡 암기 앱</title>
    <!-- Material Design Components -->
    <link href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css" rel="stylesheet">
    <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --mdc-theme-primary: #1E88E5; /* Blue 600 */
            --mdc-theme-secondary: #fdd835; /* Yellow 600 */
            --mdc-theme-on-primary: #ffffff;
            --text-primary-on-background: #212121;
            --text-secondary-on-background: #757575;
        }
        body {
            margin: 0;
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f5f5f5;
        }
        .hidden { display: none; }
        .mdc-top-app-bar { background-color: var(--mdc-theme-primary); }
        main { padding: 16px; }
        .mdc-card {
            border-radius: 12px;
            margin-bottom: 16px;
            padding: 16px;
        }
        .song-list-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .song-list-item .icon {
            font-size: 40px;
            color: var(--mdc-theme-primary);
            margin-right: 16px;
        }
        .song-list-item .info {
            flex-grow: 1;
        }
        .song-list-item .title {
            font-size: 1.1em;
            font-weight: 500;
            color: var(--text-primary-on-background);
        }
        .song-list-item .artist {
            color: var(--text-secondary-on-background);
        }
        #lyrics-content, #quiz-content {
            white-space: pre-wrap;
            line-height: 1.8;
            padding: 16px 0;
            color: var(--text-primary-on-background);
            font-size: 1.2em;
        }
        .quiz-hidden { color: var(--mdc-theme-primary); cursor: pointer; font-weight: bold; }
        .mdc-button--raised { background-color: var(--mdc-theme-primary); }
        #media-player { margin-top: 16px; }
        .media-control-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .media-control-row .label {
            width: 80px;
            font-weight: 500;
            color: var(--text-secondary-on-background);
        }
        .media-control-row .mdc-button {
            margin-left: 16px;
        }
        .back-button-large {
            height: 48px !important;
            padding: 0 24px !important;
            --mdc-typography-button-font-size: 1.25rem;
        }

        /* Game Styles */
        #game-container {
            position: relative;
            height: 85vh;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
            background: #fff;
        }
        #game-header {
            display: flex;
            justify-content: space-between;
            padding: 10px 20px;
            background: #f5f5f5;
            font-size: 1.1em;
            font-weight: 500;
        }
        #word-area {
            position: relative;
            height: calc(100% - 120px);
            width: 100%;
        }
        .falling-word {
            position: absolute;
            padding: 8px 12px;
            background-color: var(--mdc-theme-primary);
            color: white;
            border-radius: 20px;
            cursor: pointer;
            user-select: none;
            font-size: 1.1em;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: transform 0.1s ease-out;
        }
        .falling-word:hover {
            transform: scale(1.1);
        }
        #answer-area {
            position: absolute;
            bottom: 0;
            width: 100%;
            min-height: 60px;
            background: #f5f5f5;
            text-align: center;
            padding: 20px 10px;
            font-size: 1.2em;
            font-weight: 500;
            color: var(--text-primary-on-background);
            box-sizing: border-box;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }
        .answer-blank {
            display: inline-block;
            margin: 0 4px;
            padding: 0 8px;
            color: #bdbdbd;
            border-bottom: 2px solid #bdbdbd;
            min-width: 30px;
            text-align: center;
        }
        .answer-filled {
            color: var(--text-primary-on-background);
            border-bottom: 2px solid var(--mdc-theme-primary);
        }

        @keyframes fall {
            from { top: -40px; transform: rotate(0deg); }
            to { top: 100%; transform: rotate(0deg); }
        }
        .correct-click-anim {
            animation: correct-pulse 0.3s;
        }
        @keyframes correct-pulse {
            0% { transform: scale(1); background-color: #4CAF50; }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); background-color: var(--mdc-theme-primary); }
        }
        .incorrect-click-anim {
            animation: incorrect-shake 0.4s;
        }
        @keyframes incorrect-shake {
            0%, 100% { transform: translateX(0); background-color: #F44336; }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        #game-result-container .result-message {
            font-size: 1.5em;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            color: var(--mdc-theme-primary);
        }
        #game-result-container #final-lyrics {
            white-space: pre-wrap;
            line-height: 1.8;
            padding: 16px;
            background: #f9f9f9;
            border-radius: 8px;
            max-height: 50vh;
            overflow-y: auto;
        }
    </style>
</head>
<body class="mdc-typography">

    <header class="mdc-top-app-bar">
        <div class="mdc-top-app-bar__row">
            <section class="mdc-top-app-bar__section mdc-top-app-bar__section--align-start">
                <span class="mdc-top-app-bar__title">로뎀 발표곡 연습실</span>
            </section>
        </div>
    </header>

    <main class="mdc-top-app-bar--fixed-adjust">
        <div id="song-list-container" class="mdc-card">
            <h2 class="mdc-typography--headline6" style="margin-bottom: 12px;">발표곡 목록</h2>
            <ul id="song-list"></ul>
        </div>

        <div id="lyrics-container" class="mdc-card hidden">
            <button class="mdc-button back-button-large" onclick="history.back()">
                <i class="material-icons mdc-button__icon" aria-hidden="true">arrow_back</i>
                <span class="mdc-button__label">목록</span>
            </button>
            <h2 id="lyrics-title" class="mdc-typography--headline5" style="margin-top: 16px;"></h2>
            <div id="media-controls"></div>
            <div id="media-player"></div>
            <div id="lyrics-content"></div>
            <div class="mdc-card__actions">
                <button id="view-pdf-button" class="mdc-button mdc-button--raised mdc-card__action mdc-card__action--button" style="display: none;">
                    <span class="mdc-button__label">악보 보기</span>
                </button>
                <button id="start-quiz-button" class="mdc-button mdc-button--raised mdc-card__action mdc-card__action--button">
                    <span class="mdc-button__label">퀴즈 시작</span>
                </button>
                <button id="start-game-button" class="mdc-button mdc-button--raised mdc-card__action mdc-card__action--button">
                    <span class="mdc-button__label">게임 시작</span>
                </button>
            </div>
        </div>

        <div id="quiz-container" class="mdc-card hidden">
             <button class="mdc-button back-button-large" onclick="history.back()">
                <i class="material-icons mdc-button__icon" aria-hidden="true">arrow_back</i>
                <span class="mdc-button__label">가사 보기</span>
            </button>
            <h2 id="quiz-title" class="mdc-typography--headline5"></h2>
            <div id="quiz-controls">
                <button id="quiz-level-1" class="mdc-button mdc-button--raised"><span class="mdc-button__label">1단계</span></button>
                <button id="quiz-level-2" class="mdc-button mdc-button--raised"><span class="mdc-button__label">2단계</span></button>
                <button id="quiz-level-3" class="mdc-button mdc-button--raised"><span class="mdc-button__label">3단계</span></button>
                <button id="quiz-level-4" class="mdc-button mdc-button--raised"><span class="mdc-button__label">4단계</span></button>
            </div>
            <div id="quiz-content"></div>
        </div>

        <div id="game-container" class="mdc-card hidden">
            <button class="mdc-button back-button-large" onclick="history.back()">
                <i class="material-icons mdc-button__icon" aria-hidden="true">arrow_back</i>
                <span class="mdc-button__label">가사 보기</span>
            </button>
            <h2 id="game-title" class="mdc-typography--headline5"></h2>
            <div id="game-header">
                <span>시간: <span id="timer">0</span>s</span>
                <span>점수: <span id="score">0</span></span>
                <span>최고점수: <span id="high-score">0</span></span>
            </div>
            <div id="word-area"></div>
            <div id="answer-area"></div>
        </div>

        <div id="game-result-container" class="mdc-card hidden">
            <button class="mdc-button back-button-large" onclick="history.back()">
                <i class="material-icons mdc-button__icon" aria-hidden="true">arrow_back</i>
                <span class="mdc-button__label">목록</span>
            </button>
            <h2 class="mdc-typography--headline5">게임 결과</h2>
            <div class="result-message" id="final-message"></div>
            <p><strong>획득 점수:</strong> <span id="final-score"></span></p>
            <p><strong>시간 감점:</strong> <span id="time-penalty"></span></p>
            <p><strong>최종 점수:</strong> <span id="adjusted-score"></span></p>
            <p><strong>최고 점수:</strong> <span id="final-high-score"></span></p>
            <p><strong>소요 시간:</strong> <span id="final-time"></span></p>
            <h3 class="mdc-typography--headline6" style="margin-top: 24px;">전체 가사</h3>
            <div id="final-lyrics"></div>
        </div>
        
        <div id="guide-container" class="mdc-card hidden">
            <button class="mdc-button back-button-large" onclick="history.back()">
                <i class="material-icons mdc-button__icon" aria-hidden="true">arrow_back</i>
                <span class="mdc-button__label">목록</span>
            </button>
            <h2 class="mdc-typography--headline6">암기 가이드</h2>
            <ul class="mdc-list mdc-list--non-interactive">
                <li class="mdc-list-item"><span class="mdc-list-item__text">1. 전체 음악을 들으며 가사를 확인합니다.</span></li>
                <li class="mdc-list-item"><span class="mdc-list-item__text">2. 파트별 음원을 들으며 본인 파트의 가사를 익힙니다.</span></li>
                <li class="mdc-list-item"><span class="mdc-list-item__text">3. 퀴즈 기능을 통해 암기 수준을 확인합니다. (1~3단계)</span></li>
                <li class="mdc-list-item"><span class="mdc-list-item__text">4. 가려진 부분을 클릭하면 정답을 확인할 수 있습니다.</span></li>
            </ul>
        </div>

        <div id="pdf-viewer-container" class="mdc-card hidden">
            <button class="mdc-button back-button-large" onclick="history.back()">
                <i class="material-icons mdc-button__icon" aria-hidden="true">arrow_back</i>
                <span class="mdc-button__label">가사 보기</span>
            </button>
            <h2 id="pdf-title" class="mdc-typography--headline5" style="margin-top: 16px;"></h2>
            <iframe id="pdf-iframe" style="width: 100%; height: 80vh; border: none;"></iframe>
        </div>
    </main>

    <!-- Firebase SDK -->
    <script src="/__/firebase/9.6.1/firebase-app-compat.js"></script>
    <script src="/__/firebase/9.6.1/firebase-firestore-compat.js"></script>
    <script src="/__/firebase/9.6.1/firebase-auth-compat.js"></script>
    <script src="/__/firebase/init.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            mdc.autoInit();
            
            const db = firebase.firestore();
            const auth = firebase.auth();

            let songs = [];
            let currentSong = null;

            const songListContainer = document.getElementById('song-list-container');
            const lyricsContainer = document.getElementById('lyrics-container');
            const quizContainer = document.getElementById('quiz-container');
            const guideContainer = document.getElementById('guide-container');
            const pdfViewerContainer = document.getElementById('pdf-viewer-container');
            const gameContainer = document.getElementById('game-container');
            const gameResultContainer = document.getElementById('game-result-container');

            const lyricsTitle = document.getElementById('lyrics-title');
            const mediaControls = document.getElementById('media-controls');
            const mediaPlayer = document.getElementById('media-player');
            const lyricsContent = document.getElementById('lyrics-content');
            const quizTitle = document.getElementById('quiz-title');
            const quizContent = document.getElementById('quiz-content');
            const pdfTitle = document.getElementById('pdf-title');
            let pdfIframe = document.getElementById('pdf-iframe');

            // Game elements
            const gameTitle = document.getElementById('game-title');
            const timerEl = document.getElementById('timer');
            const scoreEl = document.getElementById('score');
            const highScoreEl = document.getElementById('high-score');
            const wordArea = document.getElementById('word-area');
            const answerArea = document.getElementById('answer-area');

            // Sound effects
            const correctSound = document.getElementById('correct-sound');
            const incorrectSound = document.getElementById('incorrect-sound');
            const successSound = document.getElementById('success-sound');

            function playSound(sound) {
                sound.currentTime = 0;
                sound.play();
            }

            let gameState = {};
            let timerInterval;
            let wordDropperInterval;
            let highScore = 0;

            function showView(viewToShow) {
                [songListContainer, lyricsContainer, quizContainer, guideContainer, pdfViewerContainer, gameContainer, gameResultContainer].forEach(view => {
                    if (view) view.classList.add('hidden');
                });
                if (viewToShow) viewToShow.classList.remove('hidden');
            }

            function showSongList() { showView(songListContainer); }
            function showGuide() { showView(guideContainer); }

            function showLyrics(songId) {
                const newSong = songs.find(s => s.id === songId);
                if (!newSong) return;

                const songChanged = !currentSong || currentSong.id !== songId;
                currentSong = newSong;

                lyricsTitle.textContent = currentSong.title;
                lyricsContent.textContent = currentSong.lyrics;

                const viewPdfButton = document.getElementById('view-pdf-button');
                if (currentSong.pdfUrl) {
                    viewPdfButton.style.display = 'inline-flex';
                } else {
                    viewPdfButton.style.display = 'none';
                }
                
                if (songChanged) {
                    mediaControls.innerHTML = '';
                    mediaPlayer.innerHTML = '';
                    if (currentSong.media) {
                        const partOrder = ['soprano', 'alto', 'tenor', 'bass'];
                        const partNames = { soprano: '소프라노', alto: '알토', tenor: '테너', bass: '베이스' };

                        if (currentSong.media.full) {
                            const row = createMediaControlRow('합창');
                            if (currentSong.media.full.youtube) addMediaButton(row, 'YouTube', 'youtube', currentSong.media.full.youtube);
                            if (currentSong.media.full.mp3) addMediaButton(row, 'MP3', 'mp3', currentSong.media.full.mp3);
                        }

                        if (currentSong.media.parts) {
                            partOrder.forEach(part => {
                                if (currentSong.media.parts[part] && (currentSong.media.parts[part].youtube || currentSong.media.parts[part].mp3)) {
                                    const row = createMediaControlRow(partNames[part] || part);
                                    if (currentSong.media.parts[part].youtube) addMediaButton(row, 'YouTube', 'youtube', currentSong.media.parts[part].youtube);
                                    if (currentSong.media.parts[part].mp3) addMediaButton(row, 'MP3', 'mp3', currentSong.media.parts[part].mp3);
                                }
                            });
                        }
                    }
                }
                showView(lyricsContainer);
            }

            function createMediaControlRow(labelText) {
                const row = document.createElement('div');
                row.className = 'media-control-row';
                const label = document.createElement('span');
                label.className = 'label';
                label.textContent = labelText;
                row.appendChild(label);
                mediaControls.appendChild(row);
                return row;
            }
            
            function addMediaButton(container, label, type, url) {
                const button = document.createElement('button');
                button.className = 'mdc-button mdc-button--raised';
                button.innerHTML = `<span class="mdc-button__label">${label}</span>`;
                button.onclick = () => {
                    mediaPlayer.innerHTML = '';
                    if (type === 'youtube') {
                        mediaPlayer.innerHTML = `<iframe width="100%" height="300" src="${url}" frameborder="0" allowfullscreen style="border-radius: 8px;"></iframe>`;
                    } else if (type === 'mp3') {
                        mediaPlayer.innerHTML = `<audio controls src="${url}" style="width: 100%;">Your browser does not support the audio element.</audio>`;
                    }
                };
                container.appendChild(button);
            }

            function showQuiz() {
                if (!currentSong) return;
                quizTitle.textContent = `${currentSong.title} - 퀴즈`;
                quizContent.innerHTML = '단계를 선택하세요.';
                showView(quizContainer);
            }

            function showPdfViewer() {
                if (!currentSong || !currentSong.pdfUrl) return;
                pdfTitle.textContent = `${currentSong.title} - 악보`;
                const container = document.getElementById('pdf-viewer-container');
                const oldIframe = document.getElementById('pdf-iframe');
                if (oldIframe) oldIframe.parentNode.removeChild(oldIframe);
                pdfIframe = document.createElement('iframe');
                pdfIframe.id = 'pdf-iframe';
                pdfIframe.style.width = '100%';
                pdfIframe.style.height = '80vh';
                pdfIframe.style.border = 'none';
                container.appendChild(pdfIframe);
                pdfIframe.src = `https://docs.google.com/gview?url=${currentSong.pdfUrl}&embedded=true`;
                showView(pdfViewerContainer);
            }

            function startQuiz(level) {
                if (!currentSong) return;
                const lyrics = currentSong.lyrics;
                const words = lyrics.split(/(\s+)/);
                let hideRatio = 0;
                if (level === 1) hideRatio = 0.1;
                if (level === 2) hideRatio = 0.3;
                if (level === 3) hideRatio = 0.6;
                if (level === 4) hideRatio = 0.8;

                quizContent.innerHTML = '';
                words.forEach(word => {
                    if (Math.random() < hideRatio && word.trim().length > 2) {
                        const span = document.createElement('span');
                        span.className = 'quiz-hidden';
                        span.textContent = 'ㅇ'.repeat(word.length);
                        span.dataset.original = word;
                        span.onclick = () => {
                            span.textContent = span.dataset.original;
                            span.classList.remove('quiz-hidden');
                        };
                        quizContent.appendChild(span);
                    } else {
                        quizContent.appendChild(document.createTextNode(word));
                    }
                });
            }

            // --- Game Logic ---
            function showGame() {
                if (!currentSong) return;
                gameTitle.textContent = `${currentSong.title} - 게임`;
                startGame();
                showView(gameContainer);
            }

            function startGame() {
                clearInterval(timerInterval);
                clearInterval(wordDropperInterval);
                wordArea.innerHTML = '';

                const lyricsParagraphs = currentSong.lyrics.split('\n\n').filter(p => p.trim() !== '');
                
                gameState = {
                    score: 0,
                    time: 0,
                    paragraphs: lyricsParagraphs,
                    currentParagraphIndex: 0,
                    currentWordIndex: 0,
                    totalWords: lyricsParagraphs.reduce((acc, p) => acc + p.split(/\s+/).filter(w => w).length, 0),
                    currentParagraphWords: [],
                    wordsToGuess: []
                };

                scoreEl.textContent = '0';
                timerEl.textContent = '0';
                highScore = localStorage.getItem('highScore') || 0;
                highScoreEl.textContent = highScore;
                
                timerInterval = setInterval(() => {
                    gameState.time++;
                    timerEl.textContent = gameState.time;
                }, 1000);

                wordDropperInterval = setInterval(dropWord, 1000); // Drop a new word every 1 seconds

                loadNextParagraph();
            }

            function dropWord() {
                if (gameState.wordsToGuess.length === 0) return;

                const wordIndex = Math.floor(Math.random() * gameState.wordsToGuess.length);
                const word = gameState.wordsToGuess[wordIndex];
                gameState.wordsToGuess.splice(wordIndex, 1); // Remove word from list

                const wordEl = document.createElement('div');
                wordEl.textContent = word;
                wordEl.className = 'falling-word';
                wordEl.style.left = `${Math.random() * 90}%`;
                wordEl.style.animation = `fall ${8 + Math.random() * 6}s linear forwards`;
                
                wordEl.addEventListener('click', handleWordClick);
                wordEl.addEventListener('animationend', () => {
                    if (wordEl.parentNode) {
                        wordEl.parentNode.removeChild(wordEl);
                        gameState.wordsToGuess.push(word); // Add word back if not clicked
                    }
                });

                wordArea.appendChild(wordEl);
            }

            function loadNextParagraph() {
                if (gameState.currentParagraphIndex >= gameState.paragraphs.length) {
                    endGame();
                    return;
                }

                answerArea.innerHTML = '';
                gameState.currentWordIndex = 0;

                const currentParagraph = gameState.paragraphs[gameState.currentParagraphIndex];
                const words = currentParagraph.split(/\s+/).filter(word => word.trim() !== '');
                gameState.currentParagraphWords = words;
                gameState.wordsToGuess = [...words];

                words.forEach(word => {
                    const blank = document.createElement('span');
                    blank.className = 'answer-blank';
                    blank.textContent = "_".repeat(word.length);
                    answerArea.appendChild(blank);
                    answerArea.appendChild(document.createTextNode(' ')); // Add space between blanks
                });
            }

            function handleWordClick(e) {
                const clickedWordEl = e.target;
                const clickedWord = clickedWordEl.textContent;
                const currentParagraph = gameState.paragraphs[gameState.currentParagraphIndex];
                const words = currentParagraph.split(/\s+/).filter(word => word.trim() !== '');
                const expectedWord = words[gameState.currentWordIndex];

                if (clickedWord === expectedWord) {
                    playSound(correctSound);
                    clickedWordEl.classList.add('correct-click-anim');
                    
                    setTimeout(() => {
                        if(clickedWordEl.parentNode) wordArea.removeChild(clickedWordEl);
                    }, 300);

                    const blanks = answerArea.getElementsByClassName('answer-blank');
                    if (blanks[gameState.currentWordIndex]) {
                        blanks[gameState.currentWordIndex].textContent = expectedWord;
                        blanks[gameState.currentWordIndex].classList.add('answer-filled');
                    }

                    gameState.score += 10;
                    gameState.currentWordIndex++;

                    if (gameState.currentWordIndex >= words.length) {
                        gameState.currentParagraphIndex++;
                        setTimeout(loadNextParagraph, 1000);
                    }
                } else {
                    playSound(incorrectSound);
                    gameState.score = Math.max(0, gameState.score - 5);
                    clickedWordEl.classList.add('incorrect-click-anim');
                    setTimeout(() => clickedWordEl.classList.remove('incorrect-click-anim'), 400);
                }
                scoreEl.textContent = gameState.score;
            }

            function endGame() {
                clearInterval(timerInterval);
                clearInterval(wordDropperInterval);
                playSound(successSound);

                const score = gameState.score;
                const totalWords = gameState.totalWords;
                const standardTime = totalWords * 3;
                const timePenalty = Math.max(0, gameState.time - standardTime);
                const adjustedScore = Math.max(0, score - timePenalty);

                const percentage = totalWords > 0 ? (score / (totalWords * 10)) * 100 : 0;
                let message = '';

                if (percentage < 70) {
                    message = "노력이 좀 더 필요해요...";
                } else if (percentage < 90) {
                    message = "좋아요, 수고하셨어요.";
                } else {
                    message = "최고에요, 이제 실전만 남았네요!";
                }

                if (adjustedScore > highScore) {
                    highScore = adjustedScore;
                    localStorage.setItem('highScore', highScore);
                }

                document.getElementById('final-message').textContent = message;
                document.getElementById('final-score').textContent = score;
                document.getElementById('time-penalty').textContent = `-${timePenalty}`;
                document.getElementById('adjusted-score').textContent = adjustedScore;
                document.getElementById('final-high-score').textContent = highScore;
                document.getElementById('final-time').textContent = `${gameState.time}초`;
                document.getElementById('final-lyrics').textContent = currentSong.lyrics;

                showView(gameResultContainer);
            }

            auth.signInAnonymously().then(() => {
                db.collection("songs").onSnapshot((querySnapshot) => {
                    const songListEl = document.getElementById("song-list");
                    songListEl.innerHTML = "";
                    songs = [];
                    querySnapshot.forEach((doc) => {
                        const song = { id: doc.id, ...doc.data() };
                        songs.push(song);
                        const listItem = document.createElement('li');
                        listItem.className = "song-list-item";
                        listItem.setAttribute('data-mdc-auto-init', 'MDCRipple');
                        listItem.innerHTML = `
                            <i class="material-icons icon" aria-hidden="true">music_note</i>
                            <div class="info">
                                <span class="title">${song.title}</span>
                            </div>
                            <i class="material-icons" aria-hidden="true">chevron_right</i>
                        `;
                        listItem.onclick = () => showLyrics(song.id);
                        songListEl.appendChild(listItem);
                    });
                });
            }).catch((error) => {
                console.error("Authentication failed:", error);
                const songListEl = document.getElementById("song-list");
                songListEl.innerHTML = `<li class="mdc-list-item"><span class="mdc-list-item__text">Error: ${error.message}</span></li>`;
            });

            // --- History and Navigation ---
            let isHandlingPopState = false;
            history.replaceState({ page: 'list' }, 'Song List');

            const originalShowLyrics = showLyrics;
            showLyrics = function(songId) {
                if (!isHandlingPopState) {
                    history.pushState({ page: 'lyrics', songId: songId }, 'Lyrics');
                }
                originalShowLyrics(songId);
            };

            const originalShowQuiz = showQuiz;
            showQuiz = function() {
                if (!isHandlingPopState) {
                    history.pushState({ page: 'quiz', songId: currentSong.id }, 'Quiz');
                }
                originalShowQuiz();
            };

            const originalShowPdfViewer = showPdfViewer;
            showPdfViewer = function() {
                if (!isHandlingPopState) {
                    history.pushState({ page: 'pdf', songId: currentSong.id }, 'PDF');
                }
                originalShowPdfViewer();
            };
            
            const originalShowGame = showGame;
            showGame = function() {
                if (!isHandlingPopState) {
                    history.pushState({ page: 'game', songId: currentSong.id }, 'Game');
                }
                originalShowGame();
            };

            window.addEventListener('popstate', (event) => {
                isHandlingPopState = true;
                if (event.state) {
                    switch (event.state.page) {
                        case 'list':
                            showView(songListContainer);
                            mediaPlayer.innerHTML = '';
                            mediaControls.innerHTML = '';
                            currentSong = null;
                            clearInterval(timerInterval);
                            clearInterval(wordDropperInterval);
                            break;
                        case 'lyrics':
                            originalShowLyrics(event.state.songId);
                            break;
                        case 'quiz':
                            originalShowLyrics(event.state.songId);
                            originalShowQuiz();
                            break;
                        case 'pdf':
                            originalShowLyrics(event.state.songId);
                            originalShowPdfViewer();
                            break;
                        case 'game':
                            originalShowLyrics(event.state.songId);
                            originalShowGame();
                            break;
                        default:
                            showView(songListContainer);
                    }
                }
                setTimeout(() => { isHandlingPopState = false; }, 0);
            });

            // --- Event Listeners ---
            document.getElementById('view-pdf-button').addEventListener('click', showPdfViewer);
            document.getElementById('start-quiz-button').addEventListener('click', showQuiz);
            document.getElementById('start-game-button').addEventListener('click', showGame);
            document.getElementById('quiz-level-1').addEventListener('click', () => startQuiz(1));
            document.getElementById('quiz-level-2').addEventListener('click', () => startQuiz(2));
            document.getElementById('quiz-level-3').addEventListener('click', () => startQuiz(3));
            document.getElementById('quiz-level-4').addEventListener('click', () => startQuiz(4));
        });
    </script>
    <audio id="correct-sound" src="res/correct.mp3" preload="auto"></audio>
    <audio id="incorrect-sound" src="res/incorrect.mp3" preload="auto"></audio>
    <audio id="success-sound" src="res/success.mp3" preload="auto"></audio>
</body>
</html>